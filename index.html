<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDS Converter with Well Plate</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 800px;
        }

        h1 {
            color: #333;
            margin-bottom: 2rem;
            text-align: center;
        }

        .upload-section {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: border-color 0.3s ease;
        }

        .upload-section:hover {
            border-color: #007bff;
        }

        .upload-section p {
            margin: 0;
            word-break: break-all;
            padding: 8px;
            min-height: 24px;
            color: #666;
            transition: color 0.3s ease;
        }

        .upload-button {
            background-color: #007bff;
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .upload-button:hover {
            background-color: #0056b3;
        }

        .wells-section h3 {
            text-align: center;
            margin-bottom: 1rem;
        }

        .plate-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }

        .wells-grid {
            display: grid;
            grid-template-columns: repeat(24, 30px); /* 24 columns for 384-well plate */
            gap: 4px;
            margin: 0 auto;  /* Center the grid */
        }

        .column-headers {
            grid-column: 2;
            display: grid;
            grid-template-columns: repeat(24, 30px);
            gap: 4px;
            margin-bottom: 5px;
            margin-left: 30px;
        }

        .column-header {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            font-size: 0.8em;
            color: #666;
            user-select: none;
        }

        .row-labels {
            width: 30px;
            display: grid;
            grid-template-rows: repeat(16, 1fr); /* 16 rows for 384-well plate */
            gap: 4px;
            padding-right: 10px;
        }

        .row-label {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 0.8em;
            color: #666;
            user-select: none;
            height: 30px;
        }

        .well {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .well.selected {
            background-color: #2196F3;
        }

        .well-label {
            font-size: 0.6em;
            color: #666;
            user-select: none;
            pointer-events: none;
        }

        .well.selected .well-label {
            color: white;
        }

        .process-button {
            width: 100%;
            padding: 1rem;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
            margin-top: 1rem;
        }

        .process-button:hover {
            background-color: #218838;
        }

        .drag-selection {
            position: absolute;
            border: 2px dashed #007bff;
            background-color: rgba(0, 123, 255, 0.2);
            pointer-events: none;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .well {
                width: 20px;
                height: 20px;
            }
            .well-label {
                font-size: 0.5em;
            }
            .column-headers {
                grid-template-columns: repeat(24, 20px);
                margin-left: 20px;
            }
            .column-header {
                width: 20px;
                height: 20px;
            }
            .row-labels {
                width: 20px;
            }
            .wells-grid {
                grid-template-columns: repeat(24, 20px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EDS Converter</h1>
        
        <div class="upload-section">
            <p id="instructionText">Drag or Upload Your EDS or CSV File</p>
            <div style="margin-bottom: 1.5rem;"></div>
            <label class="upload-button">
                Upload
                <input type="file" id="fileInput" accept=".eds,.csv,text/csv" hidden>
            </label>
        </div>

        <div class="wells-section">
            <h3>Choose Wells</h3>
            <div class="plate-container">
                <div class="wells-grid"></div>
            </div>
        </div>

        <button class="process-button">Process Data</button>
    </div>

    <script>
        // File upload handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const instructionText = document.getElementById('instructionText');
            if (this.files.length > 0) {
                instructionText.textContent = this.files[0].name;
                instructionText.style.color = '#333';
            } else {
                instructionText.textContent = 'Drag or Upload Your EDS or CSV File';
                instructionText.style.color = '#666';
            }
        });

        // Well plate creation for 384-well plate (16 rows, 24 columns)
        const wellsGrid = document.querySelector('.wells-grid');
        const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P'];  // 16 rows
        let isMouseDown = false;
        let selectionBox = null;

        rows.forEach((rowLabel) => {
            for (let i = 1; i <= 24; i++) {  // 24 columns
                const well = document.createElement('div');
                well.className = 'well';
                well.dataset.well = `${rowLabel}${i}`;
                
                // Add well label
                const wellLabel = document.createElement('span');
                wellLabel.className = 'well-label';
                wellLabel.textContent = `${rowLabel}${i}`;
                well.appendChild(wellLabel);

                // Add event listeners for selection
                well.addEventListener('mousedown', (e) => {
                    isMouseDown = true;
                    well.classList.toggle('selected');
                });

                well.addEventListener('mouseenter', (e) => {
                    if (isMouseDown) {
                        well.classList.toggle('selected');
                    }
                });

                wellsGrid.appendChild(well);
            }
        });

        // Mouse event handling for selection drag

        document.addEventListener('mousedown', (e) => {
            if (e.target.closest('.plate-container')) {
                isMouseDown = true;

                // Get the plate container's offset position
                const plateContainer = document.querySelector('.plate-container');
                const containerRect = plateContainer.getBoundingClientRect();
                
                // Create a selection box
                selectionBox = document.createElement('div');
                selectionBox.className = 'drag-selection';
                plateContainer.appendChild(selectionBox);

                // Set the initial position of the selection box based on mouse coordinates
                selectionBox.style.left = `${e.clientX - containerRect.left}px`;
                selectionBox.style.top = `${e.clientY - containerRect.top}px`;
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isMouseDown && selectionBox) {
                const plateContainer = document.querySelector('.plate-container');
                const containerRect = plateContainer.getBoundingClientRect();
                
                const width = e.clientX - containerRect.left - parseInt(selectionBox.style.left);
                const height = e.clientY - containerRect.top - parseInt(selectionBox.style.top);

                // Update the size of the selection box
                selectionBox.style.width = `${Math.abs(width)}px`;
                selectionBox.style.height = `${Math.abs(height)}px`;

                // Adjust the starting point if the mouse moves left or up
                if (width < 0) {
                    selectionBox.style.left = `${e.clientX - containerRect.left}px`;
                }
                if (height < 0) {
                    selectionBox.style.top = `${e.clientY - containerRect.top}px`;
                }
            }
        });

        document.addEventListener('mouseup', (e) => {
            if (isMouseDown && selectionBox) {
                isMouseDown = false;

                // Get the coordinates of the selection box
                const boxRect = selectionBox.getBoundingClientRect();
                const plateContainer = document.querySelector('.plate-container');
                const containerRect = plateContainer.getBoundingClientRect();

                // Check which wells are inside or intersecting the selection box
                document.querySelectorAll('.well').forEach(well => {
                    const wellRect = well.getBoundingClientRect();

                    // Check if the well is inside or partially intersects the selection box
                    if (
                        wellRect.left < boxRect.right &&   // Well is to the left of the right edge
                        wellRect.right > boxRect.left &&   // Well is to the right of the left edge
                        wellRect.top < boxRect.bottom &&   // Well is above the bottom edge
                        wellRect.bottom > boxRect.top      // Well is below the top edge
                    ) {
                        well.classList.add('selected');
                    }
                });

                // Remove the selection box after the selection
                plateContainer.removeChild(selectionBox);
                selectionBox = null;
            }
        });



        // Process button handler
        document.querySelector('.process-button').addEventListener('click', async () => {
            const processBtn = document.querySelector('.process-button');
            try {
                processBtn.disabled = true;
                processBtn.textContent = 'Processing...';

                const selectedWells = Array.from(document.querySelectorAll('.well.selected'))
                                        .map(well => well.dataset.well);
                
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files[0]) {
                    alert('Please upload a file first!');
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('selectedWells', JSON.stringify(selectedWells));

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    alert('File processed successfully!');
                } else {
                    alert('Error processing file.');
                }
            } catch (error) {
                alert('An error occurred while processing.');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'Process Data';
            }
        });
    </script>
</body>
</html>
